var at,socks=[],sockData=["","","","",""],MAXSOCKETS=5,ENCR_FLAGS=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],netCallbacks={create:function(host,port){if(void 0===host)return socks[sckt=MAXSOCKETS]="Wait",sockData[sckt]="",at.cmd("AT+CIPSERVER=1,"+port+"\r\n",1e4,function(d){"OK"==d?socks[sckt]=!0:(socks[sckt]=void 0,setTimeout(function(){throw new Error("CIPSERVER failed ("+(d||"Timeout")+")")},0))}),MAXSOCKETS;for(var sckt=0;void 0!==socks[sckt];)sckt++;return sckt>=MAXSOCKETS?-7:(socks[sckt]="Wait",sockData[sckt]="",at.cmd("AT+CIPSTART="+sckt+',"TCP",'+JSON.stringify(host)+","+port+"\r\n",1e4,function(d){"OK"!=d&&(socks[sckt]=-6)}),sckt)},close:function(sckt){"Wait"==socks[sckt]?socks[sckt]="WaitClose":void 0!==socks[sckt]&&(socks[sckt]<0?socks[sckt]=void 0:at.cmd((sckt==MAXSOCKETS?"AT+CIPSERVER=0":"AT+CIPCLOSE="+sckt)+"\r\n",1e3,function(d){socks[sckt]=void 0}))},accept:function(sckt){for(var i=0;i<MAXSOCKETS;i++)if("Accept"==socks[i])return socks[i]=!0,i;return-1},recv:function(sckt,maxLen){var r;return sockData[sckt]?(sockData[sckt].length>maxLen?(r=sockData[sckt].substr(0,maxLen),sockData[sckt]=sockData[sckt].substr(maxLen)):(r=sockData[sckt],sockData[sckt]="","DataClose"==socks[sckt]&&(socks[sckt]=void 0)),r):socks[sckt]<0?socks[sckt]:socks[sckt]?"":-1},send:function(sckt,data){if(at.isBusy()||"Wait"==socks[sckt])return 0;if(socks[sckt]<0)return socks[sckt];if(!socks[sckt])return-1;var cmd="AT+CIPSEND="+sckt+","+data.length+"\r\n";return at.cmd(cmd,1e4,function cb(d){return"OK"==d?(at.register("> ",function(){return at.unregister("> "),at.write(data),""}),cb):d=="Recv "+data.length+" bytes"?cb:void("SEND OK"==d?("WaitClose"==socks[sckt]&&netCallbacks.close(sckt),socks[sckt]=!0):(socks[sckt]=void 0,at.unregister("> ")))}),socks[sckt]="Wait",data.length}};function ipdHandler(line){var colon=line.indexOf(":");if(colon<0)return line;var parms=line.substring(5,colon).split(",");parms[1]=0|parms[1];var len=line.length-(colon+1);return len>=parms[1]?(sockData[parms[0]]+=line.substr(colon+1,parms[1]),line.substr(colon+parms[1]+1)):(sockData[parms[0]]+=line.substr(colon+1,len),"+IPD,"+parms[0]+","+(parms[1]-len)+":")}var wifiFuncs={ipdHandler:ipdHandler,debug:function(){return{socks:socks,sockData:sockData}},init:function(callback){at.cmd("ATE0\r\n",1e3,function cb(d){if("ATE0"==d)return cb;"OK"==d?at.cmd("AT+CIPMUX=1\r\n",1e3,function(d){callback("OK"!=d?"CIPMUX failed: "+(d||"Timeout"):null)}):callback("ATE0 failed: "+(d||"Timeout"))})},reset:function(callback){at.cmd("\r\nAT+RST\r\n",1e4,function(d){setTimeout(function(){wifiFuncs.init(callback)},1e3)})},connect:function(ssid,key,callback){at.cmd("AT+CWMODE=1\r\n",1e3,function(cwm){at.cmd("AT+CWJAP="+JSON.stringify(ssid)+","+JSON.stringify(key)+"\r\n",2e4,function cb(d){if(["WIFI DISCONNECT","WIFI CONNECTED","WIFI GOT IP","+CWJAP:1"].indexOf(d)>=0)return cb;"OK"!=d?setTimeout(callback,0,"WiFi connect failed: "+(d||"Timeout")):setTimeout(callback,0,null)})})}};function sckOpen(ln){socks[ln[0]]="Wait"==socks[ln[0]]||"Accept"}function sckClosed(ln){socks[ln[0]]=""!=sockData[ln[0]]?"DataClose":void 0}exports.connect=function(usart){return wifiFuncs.at=at=require("AT").connect(usart),require("NetworkJS").create(netCallbacks),at.register("+IPD",ipdHandler),at.registerLine("0,CONNECT",sckOpen),at.registerLine("1,CONNECT",sckOpen),at.registerLine("2,CONNECT",sckOpen),at.registerLine("3,CONNECT",sckOpen),at.registerLine("4,CONNECT",sckOpen),at.registerLine("0,CLOSED",sckClosed),at.registerLine("1,CLOSED",sckClosed),at.registerLine("2,CLOSED",sckClosed),at.registerLine("3,CLOSED",sckClosed),at.registerLine("4,CLOSED",sckClosed),wifiFuncs};